---
layout:     post
title:      "Rails 学习"
date:       2015-07-12
categories: devlang
author:     "xuanfour"
header-img: "img/post-bg-unix-linux.jpg"
tags:
    - development language
    - rails
---

# Rails 学习

## 目录

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
**Table of Contents**

- [Rails 学习](#rails-学习)
    - [目录](#目录)
    - [Rails 命令](#rails-命令)
        - [命令缩写](#命令缩写)
        - [新建项目](#新建项目)
        - [设置时区](#设置时区)
    - [Rails 主要对象](#rails-主要对象)
        - [Environment](#environment)
            - [环境判断](#环境判断)
            - [生成生产环境数据库](#生成生产环境数据库)
            - [启动生产环境](#启动生产环境)
        - [Active Record](#active-record)
            - [Model](#model)
        - [Route](#route)
        - [View](#view)
            - [Rails 的常用前端技术](#rails-的常用前端技术)
            - [参数传递](#参数传递)
            - [调试](#调试)
            - [闪现消息](#闪现消息)
        - [REST 路由](#rest-路由)
    - [杂项](#杂项)
        - [方法](#方法)
        - [符号 Symbol](#符号-symbol)
        - [数组 Array](#数组-array)
        - [值域 Range](#值域-range)
        - [散列 Hash](#散列-hash)
- [空散列](#空散列)
- [键为 ":first_name"，值为 "Michael"](#键为-firstname 值为-michael)
    - [-](#-)
    - [类](#类)
        - [具名构造方法](#具名构造方法)
        - [类的初始化](#类的初始化)
        - [类的继承](#类的继承)
        - [修改类](#修改类)
    - [常用方法](#常用方法)
        - [`String.split`](#stringsplit)
        - [`Array.join`](#arrayjoin)
        - [`String.downcase`](#stringdowncase)
        - [`String.upcase`](#stringupcase)
        - [`String.reverse`](#stringreverse)
        - [`Array.shuffle`](#arrayshuffle)
        - [`Object.inspect`](#objectinspect)
        - [`Object.class`](#objectclass)
        - [`Class.superclass`](#classsuperclass)
        - [`Hash.merge(other_hash)`](#hashmergeotherhash)
    - [注意事项](#注意事项)
    - [References](#references)

<!-- markdown-toc end -->

## Rails 命令

### 命令缩写

| 完整命令       | 缩写命令 |
| --------       | -------- |
| bundle install | bundle   |
| rails server   | rails s  |
| rails console  | rails c  |
| rails generate | rails g  |
| rails test     | rails t  |

### 新建项目

```bash
# 创建新的项目
rails new sample_app
cd sample_app

# 编辑 Gemfile
vim Gemfile

# 安装 gem
bundle install --without production
bundle update

# 编辑说明文件
vim README.md

# 初始化 Git 仓库
# git init
git add -A
git commit -m 'init'

# 启动服务，使用 C-c 中断服务
bin/rails server

# 如果有远程仓库
git remote add origin git@<url>:<user>/<repo>.git
# 如果首次推送使用
git push -u origin --all
# 如果再次推送使用
git push

# 有大的变更前最好新建一个分支
git checkout -b <branch-name>
# 首次推送分支到远程仓库
git push -u origin <branch-name>
# 修改完成后提交并合并到主分支
git add -A
git commit -m 'finish xxx'
git checkout master
git merge <branch-name>

# 生成控制器，命令的控制器名使用驼峰式，创建的控制器文件名是蛇底式
bin/rails generate controller <ControllerName> <action_name>
# 撤销前一个命令
bin/rails destroy controller <ControllerName> <action_name>

# 生成模型
bin/rails generate model <ModelName> <attr_name>:<type>
# 撤销前一个命令
bin/rails destroy model <ModelName>

# 生成数据迁移
bin/rails db:migrate
# 撤销前一个命令
bin/rails db:rollback
# 回到最开始的状态，下面的 `0` 可以修改为其他数字以回到相应版本
bin/rails db:migrate VERSION=0

# 修改 `config/routes.rb` 增加控制器动作的路由
# 将发给 `<controller>/action` 的请求映射到控制器动作。另外，get 表达这个路由响应的是 Get 请求。
get `<controller>/action`

# 集成测试
bin/rails generate integration_test site_layout
```

### 设置时区

设置时区为中国北京，打开 `config/application.rb` 中添加以下两条配置

```ruby
# 显示为北京时间
config.time_zone = "Beijing"
# 存入数据库本地时区时间
config.active_record.default_timezone = :local
# 关闭以 UTC 格式存入数据库并读取以本地时区格式读取的功能
config.active_record.time_zone_aware_attributes = false
```

> [返回目录](#目录)

## Rails 主要对象

### Environment

#### 环境判断

``` rails
Rails.env.development?
Rails.env.test?
Rails.env.production?
```

#### 生成生产环境数据库

``` bash
rails db:migrate RAILS_ENV=production
```

#### 启动生产环境

``` bash
rails server -- environment production
```

### Active Record

#### Model

``` rails
# 新建模型对象
user = User.new(...)
# 存入数据库
user.save
# 新建模型对象并存入数据库
user = User.create(...)
# 从数据库中删除模型对象
user.destroy

# 查找 id=1 的对象
User.find(1)
# 查找 name='xuan'的对象
User.find_by(name: 'xuan')
# 查找第一个
User.first
#查找所有，返回结果类似数组，但并不是，属于 User::ActiveRecord_Relation
User.all

# 更新对象数据
user.name = 'zhang'
user.save
# 同时更新对象的多个数据属性
user.update_attributes(name: 'zhang', email: 'zhang@test.com')
# 重新加载数据
user.reload

# 在模型对象类增加验证
class User < ApplicationRecord
  validates :name, presence: true, length: { maximum: 50 }
end

# 验证对象
user = User.new(...)
puts user.errors.full_messages unless user.valid?

# 用户密码设置与验证
# 用户 model 设置
has_secure_password
validates :password, presence: true, length: { minimum: 6 }
# 新建用户
User.create(name: username, email: useremail, password: userpassword, password_confirmation: userpassword)
# 密码正确，返回用户对象，否则返回 false
user.authenticate(userpassword)
# 密码正确，返回 true
!!user.authenticate(userpassword)

```

### Route ###

在 route.rb 文件中定义路径会产生具名路由，一般有两种形式：

- action_path：短路径， `/action`。
- action_ual：全路径，`http://localhost/action`。

路由定义样例：

``` rails
root 'pages#action'
get 'pages/help'
get '/about', to: 'pages#about'
get '/home', to: 'pages#home' as myhome
```

> [返回目录](#目录)

### View

#### Rails 的常用前端技术

- jQuery
- UJS
- Assets pipeline
- SJR( 服务端 JS 生成技术 )
- Turoblinks( 一种极小成本实现的单页效果的技术 )

#### 参数传递

params 是一个嵌套散列，包含每次请求的信息。
不能直接使用 params 批量赋值，有漏洞，需要通过下列方法获取：

``` rails
params.require(:user)permit(:name, :email, ...)
```

#### 调试

通过在 `application.html.erb` 里增加下列语句在页面展示调试信息：

``` rails
<%= debug(params) if Rails.env.development? %>
```

通过在控制器增加 `debugger` 方法，可以在控制台服务窗口运行调试命令，需要安装 `byebug gem`，按快捷键 `C-D` 退出。

> [返回目录](#目录)

#### 闪现消息

在 rails 中，短暂显示一个消息使用闪现消息实现。按照约定，flash 用于在两个 action 间传递临时数据，flash 中存放的所有数据会在紧接着的下一个 action 调用后清除。一般用于传递提示和错误信息。


``` rails
flash = { success: "It worked!", danger: "It failed." }
```
一共有两种通知：notice 与 alert，分别表示“提示”和“错误警告”。

- flash[:notice] 与 flash[:alert] 有多种写法：
- flash.notice= 与 flash.alert=
- flash["notice"] 与 flash["alert"]
- redirect_to 时作为参数 :alert => “…”, :notice => “…”

另外一个还会遇到的是 flash.now[]，它只对当前 action 有效，下一个 action 即无效。

- flash.now[:message] = “Hello current action”
- flash.now[]设置的数据访问方法与其它相同：均为 flash['my-key'**

**原理：***
flash.now[** 是保存在 request 中的。
alert 与 notice 是保存在 session 中的, 只是获取数据时添加了删除的逻辑。

**注意：***
flash[:alert],flash[:notice]一般与 redirect_to 一起用，而不能与 render 一起用。
redirect_to 是重定向，会重新发起请求，比 render 多了一次请求。flash[:alert],flash[:notice]只会出现在接下面的一个页面中。
而 render 是服务器端转发，客户端不会重新发送请求，比 redirect_to 少了一次请求。所以一旦一起用，结果是接下来两个页面都有 flash[:alert],flash[:notice]，第三个页面时才会消失。
正确的做法是 render 搭配 flash.now[:alert],flash.now[:notice]一起用

显示所有 notice 与 alert 的 helper

application_helper.rb 中添加：

``` rails
def display_notice_and_alert
  msg = ''
  msg << (content_tag :div, notice, :class => "notice") if notice
  msg << (content_tag :div, alert, :class => "alert") if alert
  sanitize msg
end
```

view 中只需添加：

``` rails
<%= display_notice_and_alert %>
```

> [返回目录](#目录)

### REST 路由

- post   创建
- get    显示
- patch  更新
- delete 删除

| HTTP 请求 | URL           | 动作    | 具名路由             | 作用                   |
| --------  | ----          | ----    | --------             | ----                   |
| get       | /users        | index   | users_path           | 显示所有用户的页面     |
| get       | /users/1      | show    | user_path(user)      | 显示用户的页面         |
| get       | /users/new    | new     | new_user_path        | 创建（注册）用户的页面 |
| post      | /users        | create  | users_path           | 创建新用户             |
| get       | /users/1/edit | edit    | edit_user_path(user) | 编辑用户的页面         |
| patch/put | /users/1      | update  | user_path(user)      | 更新用户信息           |
| delete    | /users/1      | destroy | user_path(user)      | 删除用户               |

> [返回目录](#目录)

## 杂项

### 方法

* 方法后缀感叹号，表示会修改对象的值。

### 符号 Symbol

* 符号可以简单看作没有约束的字符串，符号是整体的，比较的时候只比较一次，不像字符串需要每个字符去比较。
* 符号的命名一般是字母、下划线、数字，数字不能用于首位。

``` ruby
symb = :symbol
```

### 数组 Array

```ruby
arr = [0, 1, 2]
chs = %w[a b c]
```

* 数组的索引可以是负数，`-1` 是最后一个数组项。
* `%w` 用于创建元素为字符串的数组。

### 值域 Range

```ruby
val = 0..3
arr = ('a'..'g').to_a
av = arr[val]
```

### 散列 Hash

* 散列（Hash）本质上就是数组，只不过它的索引不局限于只能使用数字。三列的索引几乎可以使用任何对象，一般我们称之为“键值”。
* 调用方法时，如果散列是最后一个参数，可以省略花括号。

``` ruby
# 空散列
user = { }
# 键为 ":first_name"，值为 "Michael"
user[:first_name] = 'Michael'

# 散列的定义
ha = { 'name' => 'Bob', 'age' => 33 }
# 符号做键值的时候散列的定义可以使用简洁的语法
hasym = { name: 'Bob', age: 33}

# 散列迭代
hasym.each do |key, value|
  puts "Key #{key.inspect} has value #{value.inspect}"
end
```

### 块

```ruby
(1..5).each { |i| puts 2 * i }

(1..5).each do |i|
  puts 2 * i
end
```

### 类

#### 具名构造方法

```ruby
Object.new
String.new
Array.new
Range.new(m, n)
Hash.new
```

#### 类的初始化

```ruby
class User
  attr_accessor :name, :age

  def initialize(args = {})
    @name = args[:name]
    @age  = args[:age]
  end
end
```

#### 类的继承

* Ruby 的类继承：`String->Object->BasicObject`。
* 类定义里，self 代表的是对象本身。

```ruby
class MyClass < Object
end
```

#### 修改类

```ruby
class String
  # 回文字符串返回 true
  def palindrome?
    self == self.reverse
  end
end
```

> [返回目录](#目录)

## 常用方法

### `String.split`

字符串拆分成数组。

### `Array.join`

数组组合成字符串。

### `String.downcase`

返回小写字符串。

### `String.upcase`

返回大写字符串。

### `String.reverse`

反转字符串内容。

### `Array.shuffle`

返回乱序数组。

### `Object.inspect`

返回被调用对象的字符串字面量。

### `Object.class`

返回类。

### `Class.superclass`

返回类的父类。

### `Hash.merge(other_hash)`

返回一个新的散列，新散列是两个散列的合集，如果散列的键有重复，那么以 other_hash 的值为新散列的值。

> [返回目录](#目录)

## 注意事项

- 左值不能省略 self

> [返回目录](#目录)

## References

> [返回目录](#目录)
